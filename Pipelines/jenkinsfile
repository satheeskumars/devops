node {
  // Project Path
 def project_path = "petclinic-code"

 stage('Git ChechOut') {
  git branch: 'main', url: 'https://github.com/satheeskumars/devops.git' 
 }

 dir(project_path) {

 stage('Maven Clean') {
  sh 'mvn clean'
 }

 stage('Maven Compile') {
  sh 'mvn compile'
 }

 stage('Maven Test') {
    sh 'mvn test'
 }

 stage('Maven Package') {
  sh 'mvn package'
 }

 stage('Archive Artifact') {
  archiveArtifacts artifacts: 'target/petclinic.war', followSymlinks: false
 }

 stage('Docker Deployment') {
  sh 'docker-compose up -d --build'
 }
 
 stage('Getting Ready For Ansible Deployment'){
     sh "cp -rf target/petclinic.war terraform-code/ansible-code/roles/petclinic/files/"
 }

 stage('Terraform Deployment'){
     sh "cd terraform-code; terraform init ; terraform apply --auto-approve"
 }

 stage('Email Notification'){
 emailext (attachLog: true, body: '', subject: 'Mindtree-DevOps-Jenkins', to: 'satheeskumarbe@gmail.com')
 }

}
}
